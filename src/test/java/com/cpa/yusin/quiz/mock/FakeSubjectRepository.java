package com.cpa.yusin.quiz.mock;

import com.cpa.yusin.quiz.subject.domain.Subject;
import com.cpa.yusin.quiz.subject.service.port.SubjectRepository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageImpl;
import org.springframework.data.domain.Pageable;

import java.util.*;
import java.util.concurrent.atomic.AtomicLong;

public class FakeSubjectRepository implements SubjectRepository
{
    private final AtomicLong autoGeneratedId = new AtomicLong(1);
    private final List<Subject> data = Collections.synchronizedList(new ArrayList<>());

    @Override
    public Subject save(Subject subject)
    {
        if(subject.getId() == null || subject.getId() == 0){
            Subject newSubject = Subject.builder()
                    .id(autoGeneratedId.getAndIncrement())
                    .name(subject.getName())
                    .build();
            data.add(newSubject);
            return newSubject;
        } else{
          data.removeIf(item -> Objects.equals(item.getId(), subject.getId()));
          data.add(subject);
        }
        return subject;
    }

    @Override
    public Optional<Subject> findById(long id)
    {
        return data.stream()
                .filter(item -> item.getId().equals(id))
                .findAny();
    }

    @Override
    public Page<Subject> findAll(Pageable pageable)
    {
        List<Subject> result = data.stream()
                .limit(pageable.getPageSize())
                .skip(pageable.getOffset())
                .toList();

        return new PageImpl<>(result, pageable, data.size());
    }

    @Override
    public List<Subject> findByName(String name)
    {
        return data.stream()
                .filter(data -> data.getName().contains(name))
                .toList();
    }

    @Override
    public boolean existsById(long id)
    {
        return data.stream()
                .anyMatch(item -> item.getId().equals(id));
    }

    @Override
    public void deleteById(long id)
    {
        data.removeIf(item -> item.getId().equals(id));
    }

    @Override
    public boolean existsByName(String name)
    {
        return data.stream()
                .anyMatch(item -> item.getName().equals(name));
    }

    @Override
    public boolean existsByNameAndIdNot(long id, String name)
    {
        return data.stream()
                .anyMatch(item -> !item.getId().equals(id) && item.getName().equals(name));
    }

    @Override
    public Page<Subject> findAllOrderByName(Pageable pageable)
    {
        List<Subject> result = data.stream()
                .sorted(Comparator.comparing(Subject::getName))
                .limit(pageable.getPageSize())
                .skip(pageable.getOffset())
                .toList();

        return new PageImpl<>(result, pageable, data.size());
    }
}
