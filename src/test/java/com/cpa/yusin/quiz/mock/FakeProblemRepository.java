package com.cpa.yusin.quiz.mock;

import com.cpa.yusin.quiz.problem.domain.Problem;
import com.cpa.yusin.quiz.problem.service.port.ProblemRepository;

import java.util.*;
import java.util.concurrent.atomic.AtomicLong;

public class FakeProblemRepository implements ProblemRepository
{
    private final AtomicLong autoGeneratedId = new AtomicLong(1);
    private final List<Problem> data = Collections.synchronizedList(new ArrayList<>());

    @Override
    public Problem save(Problem problem)
    {
        if(problem.getId() == null || problem.getId() == 0){
            Problem newProblem = Problem.builder()
                    .id(autoGeneratedId.getAndIncrement())
                    .content(problem.getContent())
                    .number(problem.getNumber())
                    .exam(problem.getExam())
                    .build();

            data.add(newProblem);
            return newProblem;
        } else{
            data.removeIf(item -> Objects.equals(item.getId(), problem.getId()));
            data.add(problem);
        }
        return problem;
    }

    @Override
    public List<Problem> findAll()
    {
        return List.of();
    }

    @Override
    public List<Problem> findAllByExamId(long examId)
    {
        return data.stream()
                .filter(item -> item.getExam().getId().equals(examId))
                .toList();
    }

    @Override
    public Optional<Problem> findById(long id)
    {
        return data.stream()
                .filter(item -> item.getId().equals(id))
                .findAny();
    }


    @Override
    public boolean existsByExamIdAndNumber(Long examId, int number)
    {
        return data.stream()
                .anyMatch(p -> p.getExam().getId().equals(examId) && p.getNumber() == number);
    }
}
