name: Java CI with Gradle

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_DATABASE: testdb
          MYSQL_ROOT_PASSWORD: password
        ports:
          - 3306:3306

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: add permission
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Move test.properties
        run: |
          printf "%s" "${{ secrets.TEST_PROPERTIES }}" | base64 --decode > ./src/test/resources/application-test.properties

      - name: Test with Gradle
        run: ./gradlew clean test --info

  build:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: add permission
        run: chmod +x gradlew

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build with Gradle
        run: |
          echo "${{ secrets.APPLICATION_SECRET }}" | base64 --decode > ./src/main/resources/application-secret.yml
          ./gradlew clean build -x test

      - name: Build & push Docker image
        uses: mr-smithers-excellent/docker-build-push@v6
        with:
          image: ${{ secrets.DOCKER_USERNAME }}/yusin-quiz
          tags: latest
          registry: docker.io
          dockerfile: Dockerfile
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Set Target IP
        run: |
          # 로컬 Nginx를 통해 현재 배포된 환경(blue/green) 확인
          STATUS=$(curl -o /dev/null -w "%{http_code}" "http://${{ secrets.EC2_SERVER_IP }}/api/v1/env")
          echo "Status: $STATUS"
          
          if [ "$STATUS" = "200" ]; then
            CURRENT_UPSTREAM=$(curl -s "http://${{ secrets.EC2_SERVER_IP }}/api/v1/env")
          else
            CURRENT_UPSTREAM=green
          fi
          
          echo "CURRENT_UPSTREAM=$CURRENT_UPSTREAM" >> $GITHUB_ENV
          
          if [ "$CURRENT_UPSTREAM" = "blue" ]; then
            echo "CURRENT_PORT=8080" >> $GITHUB_ENV
            echo "STOPPED_PORT=8081" >> $GITHUB_ENV
            echo "TARGET_UPSTREAM=green" >> $GITHUB_ENV
          else
            echo "CURRENT_PORT=8081" >> $GITHUB_ENV
            echo "STOPPED_PORT=8080" >> $GITHUB_ENV
            echo "TARGET_UPSTREAM=blue" >> $GITHUB_ENV
          fi

      - name: Docker 배포 (새 버전 실행)
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.EC2_SERVER_IP }}
          key: ${{ secrets.EC2_PEM }}
          script_stop: true
          script: |
            sudo docker pull ${{ secrets.DOCKER_USERNAME }}/yusin-quiz:latest
            # 서버의 /home/ubuntu에 있는 docker-compose 파일을 활용
            sudo docker compose -f /home/ubuntu/docker-compose-${{ env.TARGET_UPSTREAM }}.yml up -d

      # [수정된 코드] 내부에서 체크 + 부팅 대기 시간 추가
      - name: 새 서버 헬스 체크 (Internal Health Check)
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.EC2_SERVER_IP }}
          key: ${{ secrets.EC2_PEM }}
          script_stop: true
          script: |
            echo "Spring Boot가 구동될 때까지 15초 대기..."
            sleep 15
            
            echo "Checking health for port ${{ env.STOPPED_PORT }}..."
            
            # 5초 간격으로 10번 시도 (총 50초+알파)
            for i in {1..10}; do
              # 127.0.0.1(내부)로 접속 시도
              RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:${{ env.STOPPED_PORT }}/api/v1/env)
            
              if [ "$RESPONSE" = "200" ]; then
                echo "Health Check Success! (Status: 200)"
                exit 0
              fi
            
              echo "Attempt $i failed (Status: $RESPONSE). Retrying in 5s..."
              sleep 5
            done
            
            echo "Health Check Failed after multiple attempts."
            # 실패 시 로그를 보여줘서 원인 파악 (컨테이너 이름은 환경변수에 따라 blue/green)
            sudo docker logs ${{ env.TARGET_UPSTREAM }} --tail 50
            exit 1

      - name: 로컬 Nginx Upstream 교체 (Blue-Green 전환)
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.EC2_SERVER_IP }}
          key: ${{ secrets.EC2_PEM }}
          script_stop: true
          script: |
            # 로컬 Nginx 설정 파일 수정 (docker exec 제거됨)
            echo "set \$service_url ${{ env.TARGET_UPSTREAM }};" | sudo tee /etc/nginx/conf.d/service-env.inc
            # Nginx 설정 다시 로드
            sudo systemctl reload nginx

      - name: 구버전 서버 중단 및 삭제
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.EC2_SERVER_IP }}
          key: ${{ secrets.EC2_PEM }}
          script_stop: true
          script: |
            sudo docker stop ${{ env.CURRENT_UPSTREAM }} || true
            sudo docker rm ${{ env.CURRENT_UPSTREAM }} || true

      - name: Docker 이미지 정리 (Prune)
        if: success()
        uses: appleboy/ssh-action@master
        with:
          username: ubuntu
          host: ${{ secrets.EC2_SERVER_IP }}
          key: ${{ secrets.EC2_PEM }}
          script: |
            sudo docker image prune -f